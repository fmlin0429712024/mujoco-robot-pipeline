version: '3.8'

services:
  triton:
    build:
      context: ./docker
      dockerfile: Dockerfile.triton
    container_name: triton-inference-server
    shm_size: '4gb'
    ports:
      - "8000:8000" # HTTP
      - "8001:8001" # gRPC
      - "8002:8002" # Metrics
    volumes:
      # Model repository
      - ./model_repository:/models
      # Mount project source code for Python backend
      - ./trossen_arm_mujoco:/workspace/trossen_arm_mujoco
      - ./scripts:/workspace/scripts
      # Mount checkpoint for model loading
      - ./outputs:/workspace/outputs
    environment:
      # Add project to Python path
      - PYTHONPATH=/workspace
      # Checkpoint location
      - CHECKPOINT_DIR=/workspace/outputs/train/act_pick_place_30k/checkpoints/030000/pretrained_model
    command: tritonserver --model-repository=/models --log-verbose=1 --model-control-mode=poll --repository-poll-secs=5
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/v2/health/ready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - trossen-network

  nim-wrapper:
    build:
      context: ./nim_wrapper
      dockerfile: Dockerfile
    container_name: nim-wrapper
    ports:
      - "8090:8000"
    environment:
      - TRITON_URL=triton:8001
      - MODEL_NAME=act_pick_place
      - MODEL_VERSION=1
      - ROS_DOMAIN_ID=42
    depends_on:
      triton:
        condition: service_healthy
    networks:
      - trossen-network

  app:
    build: .
    container_name: trossen-app
    ports:
      - "8080:8080"
    depends_on:
      nim-wrapper:
        condition: service_started
    environment:
      - INFERENCE_MODE=nim
      - INFERENCE_API_URL=http://nim-wrapper:8000
      - MUJOCO_GL=egl
      - PYOPENGL_PLATFORM=egl
      - ROS_DOMAIN_ID=42
    volumes:
      - ./data:/workspace/data
      - ./outputs:/workspace/outputs
      - ./visualizations:/workspace/visualizations
    networks:
      - trossen-network
    environment:
      - INFERENCE_MODE=nim
      - INFERENCE_API_URL=http://nim-wrapper:8000
      - MUJOCO_GL=egl
      - PYOPENGL_PLATFORM=egl
      - ROS_DOMAIN_ID=42

  ros-monitor:
    image: ros:humble-ros-base
    container_name: ros-monitor
    command: sleep infinity
    environment:
      - ROS_DOMAIN_ID=42
    networks:
      - trossen-network

networks:
  trossen-network:
    driver: bridge
